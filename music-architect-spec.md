# 音楽アーキテクト - 現行実装仕様

コードベース（`src/components/MusicArchitect.tsx`, `src/data/degreeEmotions.ts`）を読み取って整理した現状仕様。

## 構成とレイアウト
- **画面サイズ**: 幅は `min(420px, 100%)`、高さは `min(760px, 100vh - 24px)` の縦1画面構成。背景はダークグラデーション。
- **セクション**: 上から「ヘッダー（範囲/トランスポート）」「シーケンサ（4小節表示）」「感情パレット」「ナビゲーション」。
- **モバイル配慮**: グリッド/フレックスで縦に詰め込み、余白は 10–16px、タップターゲットは丸みと余裕を確保。

## データモデル
- **定数**: 8小節 (`TOTAL_BARS`)、各小節8音 (`NOTES_PER_BAR`)、表示は4小節単位 (`BARS_PER_PAGE`)。
- **シーケンス**: `SequenceCell | null` の二次元配列 `sequence[bar][note]`。`SequenceCell = { degree: DegreeKey; movement: MovementKey }`。
- **選択状態**: `selectedCell = { bar, note }` で現在カーソルを保持。初期値は 0 小節 0 音。
- **ページング**: `currentBar` は表示開始小節（0 または 4）。選択や自動進行で範囲外になれば自動でページを合わせる。
- **度数と動き**: `degreeEmotions.ts` にて `DegreeKey = Ⅰ〜Ⅶ`、`MovementKey = step/skip/leap up/down + same` を定義。

## シーケンサ
- **表示単位**: 現在ページの 4 小節を縦に並べる。各小節ヘッダーに「小節番号」「8 音」。
- **セル**: 8音を横並び。2音ごとに背景濃度を変え拍感を視覚化（`group-0〜3`）。選択セルは黄色ボーダー+拡大。配置済みセルは動きに応じた色で塗り分け。
- **色マップ（動き→背景色）**:
  - `step_up`: #3b82f6, `skip_up`: #22c55e, `leap_up`: #a855f7
  - `same`: #6b7280
  - `step_down`: #fb923c, `skip_down`: #ef4444, `leap_down`: #ec4899
- **選択操作**: 任意セルをタップすると選択し、表示ページも合わせる。

## 感情パレット
- **ヘッダー**: タイトルと「?」アイコン。アイコンで動きガイドをトグル表示（右上ドロップダイアログ）。
- **動きガイド**: 7 つの動きタブを色付きで一覧（ラベル＋説明）。現在セルの動きと一致すると枠強調。
- **度数ボタン**: 7 個を 1 行グリッドで表示。
  - 上: 推奨される動きバッジ（色付き）、中央: 度数記号、下: その組み合わせの感情ラベル。
  - クリックで選択セルに `{degree, movement}` を配置し、自動で次セルへ進む。

## 動き推定ロジック
- **前の音探索**: 選択セルより前（時間順にフラット化）の最後の配置済みセルを走査取得。
- **推定規則**:
  - 前の度数がなければ `same`。
  - 度数差 0→`same`、±1→`step_up/down`、±2→`skip_up/down`、それ以上→`leap_up/down`。
- **用途**:
  - パレットのバッジ/色と感情ラベルの提示に使用。
  - 実際に配置される `movement` もこの推定結果（手動変更はなし）。

## ナビゲーション
- 下部に「前4小節」「現在範囲」「次4小節」。1ページ目では前ボタン無効、2ページ目では次ボタン無効。
- 自動進行で次ページに跨る場合は `currentBar` を更新し表示を切り替える。

## トランスポートとオーディオ
- **BPM**: 120。単位は 8 分音符 (`EIGHTH_DURATION = 60/BPM/2`)。
- **再生**: 配置済みセルのみ順次スケジューリング。MIDI ルートは C メジャー: `Ⅰ=60, Ⅱ=62, …, Ⅶ=71`。
- **音源**: Web Audio API のサイン波。短いエンベロープで立ち上げ/減衰。全停止時にノードを掃除。
- **停止**: 手動停止または最後の音終了後に自動停止。

## スタイリング要点
- 背景: 上部がやや明るい紫→黒のグラデーション。カード/セクションは半透明ダーク＋薄い縁取り。
- タイポ: `'Noto Sans JP'` を最優先。文字色は淡い白紫系。
- 角丸: 14〜24px を多用。ボタンはピル型多め。
- レスポンシブ: 420px 以下では感情パレットを 2列/4列に畳む。

## 既知の制約・未実装
- シーケンスは8小節×8音固定、保存/ロードなし。
- 動きは自動決定のみ（手動変更やタブ選択入力はなし）。
- MIDI/オーディオ書き出し・テンポ変更は非対応。サウンドは単一サイン波。
- スナップ/クオンタイズや強弱などの編集パラメータは未実装。

## 参考データ
- **動きタブ定義**: `MOVEMENT_TABS` に色/ラベル/説明を保持。
- **感情ラベル**: `DEGREE_EMOTIONS[度数][動き]` で下記のように提供（一部抜粋）。
  - Ⅰ: `step_up=推進`, `skip_up=強い進行`, `leap_up=ドラマチック`, `same=安定`, `step_down=終止`, `skip_down=中継`, `leap_down=深い終止`
  - Ⅴ: `step_up=跳ね上がり`, `skip_up=旗印`, `leap_up=昂揚`, `same=緊張維持`, `step_down=力強さ`, `skip_down=背中押し`, `leap_down=圧倒的収束`
  - Ⅶ: `step_up=導音の緊張`, `skip_up=追い風`, `leap_up=天上の閃き`, `same=漂い`, `step_down=かすかな解放`, `skip_down=急転`, `leap_down=奈落の飛翔`
